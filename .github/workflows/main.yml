name: Build EXE and Create Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest  # Chạy trên Windows runner
    steps:
      - name: Checkout code
        uses: actions/checkout@v3  # Lấy mã nguồn từ repository

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build with PyInstaller
        run: pyinstaller --onefile dieukhieniq200.py

      - name: Retry Upload to GitHub Release
        run: |
          $success = $false
          $attempt = 0
          while ($attempt -lt 3 -and !$success) {
            $attempt++
            Write-Host "Attempt $attempt"
            try {
              gh release create v1.${{ github.run_number }} dist/dieukhieniq200.exe
              $success = $true
              Write-Host "Release created successfully"
            } catch {
              Write-Host "Retrying..."
              Start-Sleep -Seconds 10
            }
          }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
